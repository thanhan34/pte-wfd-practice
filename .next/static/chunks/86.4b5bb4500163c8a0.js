"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[86],{6104:(t,e,r)=>{r.d(e,{av:()=>u,db:()=>c,j2:()=>s});var o=r(3915),a=r(5317),i=r(6203);let n=null,c=null,s=null;try{n=(0,o.Wp)({apiKey:"AIzaSyC7LWF3rfk0K8l5BTjAxjHSmQotkOlJIt4",authDomain:"wfdpracticeroom.firebaseapp.com",projectId:"wfdpracticeroom",storageBucket:"wfdpracticeroom.firebasestorage.app",messagingSenderId:"998166005854",appId:"1:998166005854:web:c0a2e365b5d0cd6c4b0ccf",measurementId:"G-2Z5WQPZK2R"}),c=(0,a.getFirestore)(n),s=(0,i.xI)(n),Promise.resolve().then(r.bind(r,5317)).then(t=>{let{enableNetwork:e,disableNetwork:r}=t;e(c).catch(console.warn)}),console.log("✅ Firebase initialized successfully")}catch(t){throw console.error("❌ Firebase initialization failed:",t),t}async function u(){try{if(!s)return!1;return new Promise(t=>{let e=s.onAuthStateChanged(()=>{e(),t(!0)},()=>{e(),t(!1)});setTimeout(()=>{e(),t(!1)},5e3)})}catch(t){return console.error("Firebase connection check failed:",t),!1}}},9086:(t,e,r)=>{r.r(e),r.d(e,{authenticateUser:()=>u,createRoom:()=>l,deleteRoom:()=>g,getCurrentUser:()=>y,joinRoom:()=>d,leaveRoom:()=>f,setTargetPhrase:()=>h,submitAnswer:()=>p,subscribeToRoom:()=>w,updateTypingStatus:()=>m});var o=r(5317),a=r(6203),i=r(6104),n=r(9434);async function c(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;for(let r=0;r<e;r++)try{return await t()}catch(t){if(console.warn("Operation attempt ".concat(r+1," failed:"),t.message),r===e-1)throw t;await new Promise(t=>setTimeout(t,1e3*(r+1)))}throw Error("All retry attempts failed")}function s(t){return t&&t.toDate?t.toDate():new Date}async function u(){try{return(await (0,a.zK)(i.j2)).user}catch(t){throw console.error("Authentication error:",t),Error("Failed to authenticate user")}}async function l(t){return c(async()=>{if(!await (0,i.av)())throw Error("Firebase connection failed");let e=await u(),r=(0,n.S)(),a={hostId:e.uid,targetPhrase:"",createdAt:new Date,isActive:!0,participants:{[e.uid]:{nickname:t,status:"waiting",isTyping:!1,correctCount:0,totalAttempts:0}}};return await (0,o.setDoc)((0,o.doc)(i.db,"rooms",r),{...a,createdAt:(0,o.serverTimestamp)()}),console.log("✅ Room ".concat(r," created successfully")),r})}async function d(t,e){try{let r=await u(),a=(0,o.doc)(i.db,"rooms",t),n=await (0,o.getDoc)(a);if(!n.exists())throw Error("Room not found");let c=n.data();if(!c.isActive)throw Error("Room is not active");let s={...c.participants,[r.uid]:{nickname:e,status:"waiting",isTyping:!1,correctCount:0,totalAttempts:0}};await (0,o.updateDoc)(a,{participants:s})}catch(t){throw console.error("Error joining room:",t),t}}async function h(t,e){try{let r=i.j2.currentUser;if(!r)throw Error("User not authenticated");let a=(0,o.doc)(i.db,"rooms",t),n=await (0,o.getDoc)(a);if(!n.exists())throw Error("Room not found");let c=n.data();if(c.hostId!==r.uid)throw Error("Only host can set target phrase");let s={},u={};Object.entries(c.participants).forEach(t=>{let[e,r]=t;s[e]={nickname:r.nickname,status:"waiting",isTyping:!1,correctCount:r.correctCount||0,totalAttempts:r.totalAttempts||0},void 0!==r.submission&&(u["participants.".concat(e,".submission")]=(0,o.deleteField)()),void 0!==r.accuracy&&(u["participants.".concat(e,".accuracy")]=(0,o.deleteField)()),void 0!==r.submittedAt&&(u["participants.".concat(e,".submittedAt")]=(0,o.deleteField)())}),await (0,o.updateDoc)(a,{targetPhrase:e,participants:s,isCountingDown:!0,countdownStartedAt:(0,o.serverTimestamp)()}),Object.keys(u).length>0&&await (0,o.updateDoc)(a,u),setTimeout(async()=>{try{await (0,o.updateDoc)(a,{isCountingDown:!1,roundStartTime:(0,o.serverTimestamp)()})}catch(t){console.error("Error stopping countdown:",t)}},3e3)}catch(t){throw console.error("Error setting target phrase:",t),t}}async function p(t,e){try{let r=i.j2.currentUser;if(!r)throw Error("User not authenticated");let a=(0,o.doc)(i.db,"rooms",t),c=await (0,o.getDoc)(a);if(!c.exists())throw Error("Room not found");let u=c.data(),l=u.targetPhrase;if(!l)throw Error("No target phrase set");let d=(0,n.cG)(l,e),h=u.participants[r.uid],p=d.isFullyCorrect?(h.correctCount||0)+1:h.correctCount||0,m=(h.totalAttempts||0)+1,f={};if(d.isFullyCorrect&&u.roundStartTime){let t=Date.now()-s(u.roundStartTime).getTime(),e=[...h.completionTimes||[],t];f={completionTimes:e,averageTime:e.reduce((t,e)=>t+e,0)/e.length,fastestTime:Math.min(...e)}}let g={...u.participants,[r.uid]:{...u.participants[r.uid],status:"submitted",submission:e,accuracy:d,submittedAt:(0,o.serverTimestamp)(),isTyping:!1,correctCount:p,totalAttempts:m,...f}};await (0,o.updateDoc)(a,{participants:g})}catch(t){throw console.error("Error submitting answer:",t),t}}async function m(t,e){try{let r=i.j2.currentUser;if(!r)return;let a=(0,o.doc)(i.db,"rooms",t),n=await (0,o.getDoc)(a);if(!n.exists())return;let c=n.data(),s=c.participants[r.uid];if(!s||"submitted"===s.status)return;let u={...c.participants,[r.uid]:{...s,status:e?"typing":"waiting",isTyping:e}};await (0,o.updateDoc)(a,{participants:u})}catch(t){console.error("Error updating typing status:",t)}}async function f(t){try{let e=i.j2.currentUser;if(!e)return;let r=(0,o.doc)(i.db,"rooms",t),a=await (0,o.getDoc)(r);if(!a.exists())return;let n=a.data(),c={...n.participants};delete c[e.uid],n.hostId===e.uid?(await (0,o.deleteDoc)(r),console.log("✅ Room ".concat(t," deleted (host left)"))):await (0,o.updateDoc)(r,{participants:c})}catch(t){console.error("Error leaving room:",t)}}async function g(t){try{let e=i.j2.currentUser;if(!e)throw Error("User not authenticated");let r=(0,o.doc)(i.db,"rooms",t),a=await (0,o.getDoc)(r);if(!a.exists())throw Error("Room not found");if(a.data().hostId!==e.uid)throw Error("Only host can delete room");await (0,o.deleteDoc)(r),console.log("✅ Room ".concat(t," deleted"))}catch(t){throw console.error("Error deleting room:",t),t}}function w(t,e){let r=(0,o.doc)(i.db,"rooms",t);return(0,o.onSnapshot)(r,t=>{t.exists()?e(function(t){let e=t.data();return{id:t.id,hostId:e.hostId,targetPhrase:e.targetPhrase||"",createdAt:s(e.createdAt),isActive:e.isActive||!1,participants:e.participants||{},countdownStartedAt:e.countdownStartedAt?s(e.countdownStartedAt):void 0,isCountingDown:e.isCountingDown||!1,roundStartTime:e.roundStartTime?s(e.roundStartTime):void 0,currentPhraseIndex:e.currentPhraseIndex,shouldPlayAudio:e.shouldPlayAudio||!1}}(t)):e(null)},t=>{console.error("Error listening to room updates:",t),e(null)})}function y(){let t=i.j2.currentUser;return t?{id:t.uid,nickname:"",isHost:!1,joinedAt:new Date}:null}},9434:(t,e,r)=>{function o(t,e){let r=t=>t.trim().toLowerCase().replace(/\s+/g," "),o=r(t),a=r(e),i=o.split(" ").filter(t=>t.length>0),n=a.split(" ").filter(t=>t.length>0),c=[],s=[],u=[],l=[],d=new Map,h=new Map;i.forEach(t=>{d.set(t,(d.get(t)||0)+1)}),n.forEach(t=>{h.set(t,(h.get(t)||0)+1)}),d.forEach((t,e)=>{let r=Math.min(t,h.get(e)||0);for(let t=0;t<r;t++)c.push(e)}),d.forEach((t,e)=>{let r=Math.max(0,t-(h.get(e)||0));for(let t=0;t<r;t++)u.push(e)}),h.forEach((t,e)=>{let r=Math.max(0,t-(d.get(e)||0));for(let t=0;t<r;t++)l.push(e)}),n.forEach(t=>{d.has(t)||s.push(t)});let p=i.length,m=c.length,f=0===u.length&&0===s.length&&0===l.length;return{correct:c,incorrect:s,missing:u,extra:l,isFullyCorrect:f,accuracy:Math.round(100*(p>0?m/p*100:0))/100}}function a(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",e="";for(let r=0;r<6;r++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}function i(t){return t.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}function n(t){if("submitted"===t.status){var e;return(null==(e=t.accuracy)?void 0:e.isFullyCorrect)?"correct":"incorrect"}return t.status}function c(t,e){let r;return function(){for(var o=arguments.length,a=Array(o),i=0;i<o;i++)a[i]=arguments[i];clearTimeout(r),r=setTimeout(()=>t(...a),e)}}r.d(e,{CD:()=>n,S:()=>a,cG:()=>o,fU:()=>i,sg:()=>c})}}]);